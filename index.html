<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mijn Website</title>
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
  <script>
    const EMAILJS_CONFIG = {
      publicKey: 'u3fSE6bD9egjQM_nS',
      serviceId: 'service_oteoa3v',
      loginTemplateId: 'template_o5p81ny',
      templateId: 'template_f3jpuqx'
    };
    const API_URL = 'api.php';
  </script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f5f5; min-height: 100vh; }
    .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
    .navbar { background: white; padding: 15px 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; }
    .navbar h1 { color: #333; font-size: 24px; }
    .nav-menu { display: flex; gap: 20px; align-items: center; }
    .nav-link { color: #007bff; text-decoration: none; font-weight: 500; }
    .nav-link:hover { text-decoration: underline; }
    .user-info { display: flex; align-items: center; gap: 15px; }
    .user-info img { width: 36px; height: 36px; border-radius: 50%; object-fit: cover; }
    .btn { padding: 8px 16px; border: none; border-radius: 5px; cursor: pointer; font-size: 14px; font-weight: 500; }
    .btn-primary { background: #007bff; color: white; }
    .btn-primary:hover { background: #0056b3; }
    .btn-secondary { background: #6c757d; color: white; }
    .btn-success { background: #28a745; color: white; }
    .btn-danger { background: #dc3545; color: white; }
    .btn-small { padding: 5px 10px; font-size: 12px; }
    .login-container { max-width: 400px; margin: 50px auto; background: white; border-radius: 8px; padding: 30px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    .login-tabs { display: flex; gap: 10px; margin-bottom: 20px; }
    .login-tabs .btn { flex: 1; }
    .login-tabs .btn.active { background: #007bff; }
    .form-group { margin-bottom: 15px; }
    .form-group label { display: block; margin-bottom: 5px; font-weight: 500; color: #333; }
    .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px; }
    .form-group input:focus { outline: none; border-color: #007bff; }
    .error-message { color: #dc3545; font-size: 14px; margin-bottom: 10px; }
    .success-message { color: #28a745; font-size: 14px; margin-bottom: 10px; }
    .error-text { color: #dc3545; font-size: 12px; margin-top: 5px; }
    .spinner { display: inline-block; animation: spin 1s linear infinite; }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    
    .blog-section { margin-bottom: 40px; }
    .blog-section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid #007bff; }
    .blog-section-title { font-size: 24px; color: #333; }
    .blogs-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 20px; }
    .blog-card { background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .blog-card-image { width: 100%; height: 200px; object-fit: cover; }
    .blog-card-content { padding: 15px; }
    .blog-card-title { font-size: 18px; font-weight: 600; color: #333; margin-bottom: 10px; }
    .blog-card-description { color: #666; font-size: 14px; line-height: 1.5; margin-bottom: 10px; }
    .blog-card-tags { margin: 8px 0; }
    .tag { display: inline-block; background: #e9ecef; color: #495057; padding: 2px 8px; border-radius: 12px; font-size: 11px; margin-right: 5px; cursor: pointer; }
    .tag:hover { background: #007bff; color: white; }
    .blog-card-meta { color: #999; font-size: 12px; }
    .empty-state { text-align: center; padding: 40px; color: #666; }
    
    .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 1000; }
    .modal { background: white; border-radius: 8px; padding: 25px; width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto; }
    .modal h2 { margin-bottom: 20px; color: #333; }
    .modal-actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px; }
    
    .editor-toolbar { border: 1px solid #ddd; border-bottom: none; padding: 5px; border-radius: 5px 5px 0 0; background: #f8f9fa; }
    .editor-btn { padding: 5px 10px; border: 1px solid #ddd; background: white; cursor: pointer; font-size: 14px; }
    .editor-btn:hover { background: #e9ecef; }
    .editor-content { border: 1px solid #ddd; border-radius: 0 0 5px 5px; padding: 10px; min-height: 150px; font-size: 14px; }
    .image-upload-container { border: 2px dashed #ddd; padding: 20px; text-align: center; border-radius: 5px; }
    .image-upload-preview { margin-top: 10px; }
    .image-upload-preview img { max-width: 100%; max-height: 200px; border-radius: 5px; }
  </style>
</head>
<body>
  <nav class="navbar">
    <h1>Mijn Website</h1>
    <div class="nav-menu" id="navMenu" style="display: none;">
      <a href="#" class="nav-link" id="dashboardLink" style="display: none;">Dashboard</a>
    </div>
    <div class="user-info" id="userInfo" style="display: none;">
      <img id="userProfilePhoto" style="width: 36px; height: 36px; border-radius: 50%; object-fit: cover; display: none;">
      <span id="loggedInUser"></span>
      <button class="btn btn-secondary" id="logoutBtn">Uitloggen</button>
    </div>
  </nav>

  <div id="loginSection" class="container" style="display: none;">
    <div class="login-container">
      <div class="login-tabs">
        <button class="btn btn-secondary active" id="loginTab">Inloggen</button>
        <button class="btn btn-secondary" id="registerTab">Aanmelden</button>
      </div>
      
      <div id="loginForm">
        <div class="form-group">
          <label>Emailadres</label>
          <input type="email" id="loginEmail">
        </div>
        <div class="form-group" id="loginCodeGroup" style="display: none;">
          <label>Verificatiecode</label>
          <input type="text" id="loginCode" maxlength="6" placeholder="6-cijferige code" style="text-align: center; letter-spacing: 5px;">
        </div>
        <div class="error-message" id="loginError" style="display: none;"></div>
        <button class="btn btn-primary" style="width: 100%;" id="sendCodeBtn">
          <span id="sendCodeBtnText">Verstuur verificatiecode</span>
          <span id="sendCodeBtnSpinner" class="spinner" style="display: none;">&#9696;</span>
        </button>
        <button class="btn btn-primary" style="width: 100%; display: none;" id="loginBtn">Inloggen met code</button>
      </div>
      
      <div id="registerForm" style="display: none;">
        <p style="text-align: center; margin-bottom: 20px; color: #666;">
          Maak een account aan. Na registratie kun je direct inloggen.
        </p>
        <div class="form-group" style="text-align: center; margin-bottom: 20px;">
          <label>Profielfoto</label>
          <div id="profilePhotoUpload">
            <input type="file" id="regProfilePhoto" accept="image/*" onchange="handleProfilePhotoUpload(this)">
          </div>
          <div id="profilePhotoPreview" style="display: none; margin-top: 10px;">
            <img id="profilePhotoImg" style="width: 100px; height: 100px; border-radius: 50%; object-fit: cover; border: 2px solid #ddd;">
            <button type="button" class="btn btn-danger btn-small" onclick="removeProfilePhoto()" style="display: block; margin: 10px auto 0;">Verwijder</button>
          </div>
        </div>
        <div class="form-group">
          <label>Voornaam *</label>
          <input type="text" id="regVoornaam">
        </div>
        <div class="form-group">
          <label>Tussenvoegsel</label>
          <input type="text" id="regTussenvoegsel">
        </div>
        <div class="form-group">
          <label>Achternaam *</label>
          <input type="text" id="regAchternaam">
        </div>
        <div class="form-group">
          <label>Emailadres *</label>
          <input type="email" id="regEmailadres">
        </div>
        <div class="error-message" id="registerError" style="display: none;"></div>
        <div class="success-message" id="registerSuccess" style="display: none;"></div>
        <button class="btn btn-primary" style="width: 100%;" id="registerBtn">Account aanmaken</button>
      </div>
    </div>
  </div>

  <div id="mainContent" class="container" style="display: none;">
    <div id="blogSections"></div>
  </div>

  <div class="modal-overlay" id="blogModal">
    <div class="modal" style="max-width: 600px;">
      <h2 id="blogModalTitle">Nieuwe blog</h2>
      <div class="form-group">
        <label>Titel *</label>
        <input type="text" id="blogTitel">
        <div class="error-text" id="blogTitelError" style="display: none;"></div>
      </div>
      <div class="form-group">
        <label>Blog type *</label>
        <select id="blogTypeSelect"></select>
      </div>
      <div class="form-group">
        <label>Omschrijving *</label>
        <div class="editor-toolbar">
          <button type="button" class="editor-btn" onclick="execCmd('bold')" title="Vet"><b>B</b></button>
          <button type="button" class="editor-btn" onclick="execCmd('italic')" title="Cursief"><i>I</i></button>
          <button type="button" class="editor-btn" onclick="execCmd('underline')" title="Onderstreept"><u>U</u></button>
          <button type="button" class="editor-btn" onclick="execCmd('insertUnorderedList')" title="Lijst">&#8226;</button>
        </div>
        <div id="blogOmschrijving" class="editor-content" contenteditable="true"></div>
        <div class="error-text" id="blogOmschrijvingError" style="display: none;"></div>
      </div>
      <div class="form-group">
        <label>Afbeelding (min 900x300) *</label>
        <div class="image-upload-container">
          <input type="file" id="blogImageFile" accept="image/*" onchange="handleImageUpload(this)">
          <div id="imageUploadPreview" class="image-upload-preview" style="display: none;">
            <img id="uploadedImagePreview">
            <button type="button" class="btn btn-danger btn-small" onclick="removeUploadedImage()">Verwijder</button>
          </div>
        </div>
        <div class="error-text" id="blogAfbeeldingError" style="display: none;"></div>
      </div>
      <div class="modal-actions">
        <button class="btn btn-secondary" id="cancelBlogBtn">Annuleren</button>
        <button class="btn btn-primary" id="saveBlogBtn">Opslaan</button>
      </div>
    </div>
  </div>

  <script>
    let currentUser = null;
    let blogTypes = [];
    let userPermissions = {};
    let allBlogs = [];
    let editingBlogId = null;
    let uploadedImageUrl = null;
    let profilePhotoUrl = null;

    async function init() {
      await checkSession();
      setupEventListeners();
      if (typeof emailjs !== 'undefined') {
        emailjs.init(EMAILJS_CONFIG.publicKey);
      }
    }

    async function checkSession() {
      try {
        const response = await fetch(API_URL + '?action=checkSession');
        const data = await response.json();
        if (data.loggedIn) {
          currentUser = data.user;
          showMainContent();
        } else {
          showLoginSection();
        }
      } catch (error) {
        showLoginSection();
      }
    }

    function showLoginSection() {
      document.getElementById('loginSection').style.display = 'block';
      document.getElementById('mainContent').style.display = 'none';
      document.getElementById('userInfo').style.display = 'none';
      document.getElementById('navMenu').style.display = 'none';
    }

    function showMainContent() {
      document.getElementById('loginSection').style.display = 'none';
      document.getElementById('mainContent').style.display = 'block';
      document.getElementById('userInfo').style.display = 'flex';
      document.getElementById('navMenu').style.display = 'flex';
      document.getElementById('loggedInUser').textContent = currentUser.naam + ' (' + currentUser.rol + ')';
      
      if (currentUser.rol === 'Beheerder') {
        document.getElementById('dashboardLink').style.display = 'inline';
      } else {
        document.getElementById('dashboardLink').style.display = 'none';
      }
      
      const profilePhotoEl = document.getElementById('userProfilePhoto');
      if (currentUser.profielfoto) {
        profilePhotoEl.src = currentUser.profielfoto;
        profilePhotoEl.style.display = 'block';
      } else {
        profilePhotoEl.style.display = 'none';
      }
      
      loadBlogTypes();
    }

    async function loadBlogTypes() {
      try {
        const response = await fetch(API_URL + '?action=getContentTypes');
        blogTypes = await response.json();
        
        const select = document.getElementById('blogTypeSelect');
        select.innerHTML = blogTypes.map(t => `<option value="${t.id}">${t.naam}</option>`).join('');
        
        const response2 = await fetch(API_URL + '?action=getRoles');
        const roles = await response2.json();
        const userRole = roles.find(r => r.naam === currentUser.rol);
        userPermissions = userRole ? (userRole.permissions || {}) : {};
        
        const response3 = await fetch(API_URL + '?action=getBlogs');
        allBlogs = await response3.json();
        
        renderBlogSections();
      } catch (error) {
        console.error('Fout bij laden blog types:', error);
      }
    }

    let currentTagFilter = null;

    function filterByTag(tag) {
      currentTagFilter = tag;
      renderBlogSections();
    }

    function clearTagFilter() {
      currentTagFilter = null;
      renderBlogSections();
    }

    function renderBlogSections() {
      const container = document.getElementById('blogSections');
      container.innerHTML = '';
      
      if (currentTagFilter) {
        container.innerHTML += `
          <div style="background: #e7f3ff; padding: 15px; border-radius: 8px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
            <span>Filtering by tag: <strong>${currentTagFilter}</strong></span>
            <button class="btn btn-secondary btn-small" onclick="clearTagFilter()">Clear filter</button>
          </div>
        `;
      }
      
      const typesToShow = currentTagFilter ? blogTypes : blogTypes;
      
      typesToShow.forEach(type => {
        const perms = userPermissions[type.id] || {};
        const canRead = perms.read;
        const canCreate = perms.create || false;
        
        if (canRead === false) {
          return;
        }
        
        let typeBlogs = allBlogs.filter(b => b.content_type_id == type.id);
        
        if (currentTagFilter) {
          typeBlogs = typeBlogs.filter(blog => {
            let tags = [];
            if (blog.tags) {
              try {
                tags = typeof blog.tags === 'string' ? JSON.parse(blog.tags) : blog.tags;
              } catch (e) {}
            }
            return tags.includes(currentTagFilter);
          });
        }
        
        const section = document.createElement('div');
        section.className = 'blog-section';
        
        if (currentTagFilter && typeBlogs.length === 0) {
          return;
        }
        
        section.innerHTML = `
          <div class="blog-section-header">
            <h2 class="blog-section-title">${type.naam}</h2>
            ${canCreate ? `<button class="btn btn-primary btn-small" onclick="openNewBlogModal('${type.id}')">Nieuwe ${type.naam}</button>` : ''}
          </div>
          ${typeBlogs.length === 0 ? '<div class="empty-state">Nog geen berichten in deze categorie.</div>' : `
            <div class="blogs-grid">
              ${typeBlogs.map(blog => {
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = blog.omschrijving || '';
                const plainText = tempDiv.textContent || '';
                const truncated = plainText.substring(0, 120) + (plainText.length > 120 ? '...' : '');
                const canEdit = (userPermissions[type.id] || {}).edit || false;
                
                let tags = [];
                if (blog.tags) {
                  try {
                    tags = typeof blog.tags === 'string' ? JSON.parse(blog.tags) : blog.tags;
                  } catch (e) {}
                }
                
                return `
                <div class="blog-card">
                  <img class="blog-card-image" src="${blog.afbeelding || 'data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'400\' height=\'200\'%3E%3Crect fill=\'%23ddd\' width=\'400\' height=\'200\'/%3E%3Ctext fill=\'%23999\' x=\'50%25\' y=\'50%25\' text-anchor=\'middle\'%3EGeen%3C/text%3E%3C/svg%3E'}" alt="${blog.titel}" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'400\' height=\'200\'%3E%3Crect fill=\'%23ddd\' width=\'400\' height=\'200\'/%3E%3Ctext fill=\'%23999\' x=\'50%25\' y=\'50%25\' text-anchor=\'middle\'%3EGeen%3C/text%3E%3C/svg%3E'">
                  <div class="blog-card-content">
                    <div class="blog-card-title">${blog.titel}</div>
                    <div class="blog-card-description">${truncated}</div>
                    ${tags.length > 0 ? `<div class="blog-card-tags">${tags.map(t => `<span class="tag" onclick="filterByTag('${t}')">${t}</span>`).join('')}</div>` : ''}
                    <div class="blog-card-meta">${blog.voornaam} ${blog.achternaam} - ${new Date(blog.created_at).toLocaleDateString('nl-NL')}</div>
                    ${canEdit ? `
                    <div style="margin-top: 10px;">
                      <button class="btn btn-secondary btn-small" onclick="editBlog('${blog.id}')">Wijzig</button>
                    </div>
                    ` : ''}
                  </div>
                </div>
              `}).join('')}
            </div>
          `}
        `;
        container.appendChild(section);
      });
    }

    async function loadAllBlogs() {
      try {
        const response = await fetch(API_URL + '?action=getBlogs');
        allBlogs = await response.json();
        updateBlogDisplays();
      } catch (error) {
        console.error('Fout bij laden blogs:', error);
      }
    }

    function updateBlogDisplays() {
      blogTypes.forEach(type => {
        const typeBlogs = allBlogs.filter(b => b.content_type_id == type.id);
      });
      renderBlogSections();
    }

    function openNewBlogModal(typeId) {
      editingBlogId = null;
      document.getElementById('blogModalTitle').textContent = 'Nieuwe blog';
      document.getElementById('blogTitel').value = '';
      document.getElementById('blogOmschrijving').innerHTML = '';
      document.getElementById('blogTypeSelect').value = typeId;
      document.getElementById('blogImageFile').style.display = 'block';
      document.getElementById('blogImageFile').value = '';
      document.getElementById('imageUploadPreview').style.display = 'none';
      uploadedImageUrl = null;
      document.getElementById('blogModal').style.display = 'flex';
    }

    function editBlog(id) {
      const blog = allBlogs.find(b => b.id == id);
      if (!blog) return;
      
      editingBlogId = id;
      document.getElementById('blogModalTitle').textContent = 'Blog wijzigen';
      document.getElementById('blogTitel').value = blog.titel;
      document.getElementById('blogOmschrijving').innerHTML = blog.omschrijving || '';
      document.getElementById('blogTypeSelect').value = blog.content_type_id;
      
      if (blog.afbeelding) {
        uploadedImageUrl = blog.afbeelding;
        document.getElementById('uploadedImagePreview').src = blog.afbeelding;
        document.getElementById('imageUploadPreview').style.display = 'block';
        document.getElementById('blogImageFile').style.display = 'none';
      } else {
        uploadedImageUrl = null;
        document.getElementById('blogImageFile').style.display = 'block';
        document.getElementById('blogImageFile').value = '';
        document.getElementById('imageUploadPreview').style.display = 'none';
      }
      
      document.getElementById('blogModal').style.display = 'flex';
    }

    function closeBlogModal() {
      document.getElementById('blogModal').style.display = 'none';
      editingBlogId = null;
    }

    async function handleImageUpload(input) {
      const file = input.files[0];
      if (!file) return;
      
      const formData = new FormData();
      formData.append('image', file);
      
      try {
        const response = await fetch(API_URL + '?action=uploadImage', { method: 'POST', body: formData });
        const data = await response.json();
        
        if (data.error) {
          alert(data.error);
          return;
        }
        
        if (data.url) {
          uploadedImageUrl = data.url;
          const img = new Image();
          img.onload = function() {
            if (this.naturalWidth < 900 || this.naturalHeight < 300) {
              document.getElementById('blogAfbeeldingError').textContent = `Afbeelding is ${this.naturalWidth}x${this.naturalHeight}. Minimaal 900x300 vereist.`;
              document.getElementById('blogAfbeeldingError').style.display = 'block';
              uploadedImageUrl = null;
            } else {
              document.getElementById('blogAfbeeldingError').style.display = 'none';
              document.getElementById('uploadedImagePreview').src = data.url;
              document.getElementById('imageUploadPreview').style.display = 'block';
              input.style.display = 'none';
            }
          };
          img.src = data.url;
        }
      } catch (error) {
        alert('Fout bij uploaden afbeelding');
      }
    }

    function removeUploadedImage() {
      uploadedImageUrl = null;
      document.getElementById('blogImageFile').value = '';
      document.getElementById('blogImageFile').style.display = 'block';
      document.getElementById('imageUploadPreview').style.display = 'none';
    }

    async function saveBlog() {
      const titel = document.getElementById('blogTitel').value.trim();
      const omschrijving = document.getElementById('blogOmschrijving').innerHTML;
      const content_type_id = document.getElementById('blogTypeSelect').value;
      const afbeelding = uploadedImageUrl;
      
      let hasError = false;
      
      if (!titel) {
        document.getElementById('blogTitelError').textContent = 'Titel is verplicht';
        document.getElementById('blogTitelError').style.display = 'block';
        hasError = true;
      } else {
        document.getElementById('blogTitelError').style.display = 'none';
      }
      
      if (!omschrijving || omschrijving.trim() === '') {
        document.getElementById('blogOmschrijvingError').textContent = 'Omschrijving is verplicht';
        document.getElementById('blogOmschrijvingError').style.display = 'block';
        hasError = true;
      } else {
        document.getElementById('blogOmschrijvingError').style.display = 'none';
      }
      
      if (!afbeelding) {
        document.getElementById('blogAfbeeldingError').textContent = 'Afbeelding is verplicht';
        document.getElementById('blogAfbeeldingError').style.display = 'block';
        hasError = true;
      } else {
        document.getElementById('blogAfbeeldingError').style.display = 'none';
      }
      
      if (hasError) return;
      
      try {
        const action = editingBlogId ? 'updateBlog' : 'addBlog';
        const body = editingBlogId 
          ? { id: editingBlogId, titel, omschrijving, content_type_id, afbeelding }
          : { titel, omschrijving, content_type_id, afbeelding };
        
        const response = await fetch(API_URL + '?action=' + action, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });
        
        const data = await response.json();
        
        if (data.error) {
          alert(data.error);
          return;
        }
        
        closeBlogModal();
        loadBlogTypes();
      } catch (error) {
        alert('Fout bij opslaan blog');
      }
    }

    async function handleProfilePhotoUpload(input) {
      const file = input.files[0];
      if (!file) return;
      
      const formData = new FormData();
      formData.append('image', file);
      
      try {
        const response = await fetch(API_URL + '?action=uploadImage', { method: 'POST', body: formData });
        const data = await response.json();
        
        if (data.error) {
          alert(data.error);
          return;
        }
        
        if (data.url) {
          profilePhotoUrl = data.url;
          document.getElementById('profilePhotoImg').src = data.url;
          document.getElementById('profilePhotoPreview').style.display = 'block';
          input.style.display = 'none';
        }
      } catch (error) {
        alert('Fout bij uploaden profielfoto');
      }
    }

    function removeProfilePhoto() {
      profilePhotoUrl = null;
      document.getElementById('regProfilePhoto').value = '';
      document.getElementById('regProfilePhoto').style.display = 'block';
      document.getElementById('profilePhotoPreview').style.display = 'none';
    }

    function execCmd(command) {
      document.execCommand(command, false, null);
      document.getElementById('blogOmschrijving').focus();
    }

    async function doLogin() {
      const emailadres = document.getElementById('loginEmail').value.trim();
      const code = document.getElementById('loginCode')?.value.trim();
      const errorEl = document.getElementById('loginError');
      const sendCodeBtn = document.getElementById('sendCodeBtn');
      const sendCodeBtnText = document.getElementById('sendCodeBtnText');
      const sendCodeBtnSpinner = document.getElementById('sendCodeBtnSpinner');
      
      errorEl.style.display = 'none';
      
      if (!emailadres) {
        errorEl.textContent = 'Vul je emailadres in';
        errorEl.style.display = 'block';
        return;
      }
      
      sendCodeBtn.disabled = true;
      if (sendCodeBtnText) sendCodeBtnText.textContent = 'Verificatiecode wordt verstuurd...';
      if (sendCodeBtnSpinner) sendCodeBtnSpinner.style.display = 'inline-block';
      
      try {
        const response = await fetch(API_URL + '?action=login', {
          method: 'POST',
          credentials: 'include',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ emailadres, code })
        });
        
        const data = await response.json();
        
        if (data.error) {
          errorEl.textContent = data.error;
          errorEl.style.display = 'block';
          sendCodeBtn.disabled = false;
          if (sendCodeBtnText) sendCodeBtnText.textContent = 'Verstuur verificatiecode';
          if (sendCodeBtnSpinner) sendCodeBtnSpinner.style.display = 'none';
        } else if (data.send_email) {
          if (typeof emailjs !== 'undefined') {
            await emailjs.send(EMAILJS_CONFIG.serviceId, EMAILJS_CONFIG.loginTemplateId, {
              to_name: data.voornaam || 'Gebruiker',
              to_email: data.email,
              verification_code: data.code,
              expiry_time: '10 minuten'
            });
          }
          
          document.getElementById('loginCodeGroup').style.display = 'block';
          document.getElementById('sendCodeBtn').style.display = 'none';
          document.getElementById('loginBtn').style.display = 'block';
          document.getElementById('loginCode').focus();
          errorEl.textContent = 'Er is een verificatiecode verstuurd naar je email';
          errorEl.style.display = 'block';
        } else if (data.success) {
          currentUser = data.user;
          showMainContent();
          document.getElementById('loginEmail').value = '';
          document.getElementById('loginCode').value = '';
          document.getElementById('loginCodeGroup').style.display = 'none';
          sendCodeBtn.style.display = 'block';
          sendCodeBtn.disabled = false;
          if (sendCodeBtnText) sendCodeBtnText.textContent = 'Verstuur verificatiecode';
          if (sendCodeBtnSpinner) sendCodeBtnSpinner.style.display = 'none';
          document.getElementById('loginBtn').style.display = 'none';
        }
      } catch (error) {
        errorEl.textContent = 'Verbindingsfout';
        errorEl.style.display = 'block';
        sendCodeBtn.disabled = false;
        if (sendCodeBtnText) sendCodeBtnText.textContent = 'Verstuur verificatiecode';
        if (sendCodeBtnSpinner) sendCodeBtnSpinner.style.display = 'none';
      }
    }

    async function doRegister() {
      const voornaam = document.getElementById('regVoornaam').value.trim();
      const tussenvoegsel = document.getElementById('regTussenvoegsel').value.trim();
      const achternaam = document.getElementById('regAchternaam').value.trim();
      const emailadres = document.getElementById('regEmailadres').value.trim();
      const errorEl = document.getElementById('registerError');
      const successEl = document.getElementById('registerSuccess');
      
      errorEl.style.display = 'none';
      successEl.style.display = 'none';
      
      if (!voornaam || !achternaam || !emailadres) {
        errorEl.textContent = 'Alle velden zijn verplicht';
        errorEl.style.display = 'block';
        return;
      }
      
      try {
        const response = await fetch(API_URL + '?action=register', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ voornaam, tussenvoegsel, achternaam, emailadres, profielfoto: profilePhotoUrl })
        });
        
        const data = await response.json();
        
        if (data.error) {
          errorEl.textContent = data.error;
          errorEl.style.display = 'block';
          return;
        } else if (data.success) {
          successEl.textContent = data.message || 'Account aangemaakt! Je kunt nu inloggen.';
          successEl.style.display = 'block';
          document.getElementById('regVoornaam').value = '';
          document.getElementById('regTussenvoegsel').value = '';
          document.getElementById('regAchternaam').value = '';
          document.getElementById('regEmailadres').value = '';
          removeProfilePhoto();
          
          setTimeout(() => {
            document.getElementById('loginTab').click();
            successEl.style.display = 'none';
          }, 2000);
        }
      } catch (error) {
        errorEl.textContent = 'Verbindingsfout';
        errorEl.style.display = 'block';
      }
    }

    async function doLogout() {
      try {
        await fetch(API_URL + '?action=logout', { credentials: 'include' });
      } catch (e) {}
      currentUser = null;
      showLoginSection();
    }

    function setupEventListeners() {
      document.getElementById('loginTab').addEventListener('click', () => {
        document.getElementById('loginTab').classList.add('active');
        document.getElementById('registerTab').classList.remove('active');
        document.getElementById('loginForm').style.display = 'block';
        document.getElementById('registerForm').style.display = 'none';
      });

      document.getElementById('registerTab').addEventListener('click', () => {
        document.getElementById('registerTab').classList.add('active');
        document.getElementById('loginTab').classList.remove('active');
        document.getElementById('registerForm').style.display = 'block';
        document.getElementById('loginForm').style.display = 'none';
      });

      document.getElementById('sendCodeBtn').addEventListener('click', doLogin);
      document.getElementById('loginBtn').addEventListener('click', doLogin);
      document.getElementById('loginEmail').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') doLogin();
      });
      document.getElementById('loginCode').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') doLogin();
      });

      document.getElementById('registerBtn').addEventListener('click', (e) => {
        e.preventDefault();
        doRegister();
      });

      document.getElementById('logoutBtn').addEventListener('click', doLogout);

      document.getElementById('dashboardLink').addEventListener('click', (e) => {
        e.preventDefault();
        window.location.href = 'dashboard.html';
      });

      document.getElementById('cancelBlogBtn').addEventListener('click', closeBlogModal);
      document.getElementById('saveBlogBtn').addEventListener('click', saveBlog);
    }

    init();
  </script>
</body>
</html>
